# 문서 익명화 기능 문서

## 📋 개요

**CaseNetAI 문서 익명화** 기능은 노인보호전문기관 종사자가 민감한 개인정보가 포함된 문서를 AI 분석에 활용하기 전에 **안전하게 익명화**할 수 있도록 지원합니다.

### 주요 특징
- ✅ **AI API 불필요**: 규칙 기반 탐지로 비용 없이 사용 가능
- ✅ **일관성 보장**: 동일한 정보는 항상 동일한 익명 코드로 변환
- ✅ **다양한 형식 지원**: DOCX, PDF, TXT 파일 처리
- ✅ **매핑 테이블 제공**: 원본 ↔ 익명화 대응표 다운로드
- ✅ **한국어 최적화**: 한국 이름, 주소, 연락처 패턴 인식

---

## 🎯 사용 목적

### 문제 상황
노인보호전문기관에서 작성된 상담일지, 조사보고서 등에는:
- 👤 피해노인/신고자/행위자의 **실명**
- 🏢 요양시설, 복지관 등의 **시설명**
- 📞 전화번호, 주소 등의 **연락처**
- 🆔 주민등록번호

이러한 민감정보가 포함되어 있어, AI에게 문서 분석을 맡기기 위해서는 **개인정보 익명화**가 필수입니다.

### 해결 방법
1. 문서 업로드 (Word, PDF, TXT)
2. 자동 개인정보 탐지 및 익명화
3. 익명화된 문서 다운로드
4. AI 분석 진행
5. 필요 시 매핑 테이블로 원본 복원

---

## 🔧 기술 구조

### 1. 백엔드 서비스

#### `anonymizationService.js`
**규칙 기반 PII (개인식별정보) 탐지 엔진**

```javascript
// 주요 기능
- 주민등록번호 탐지: 000000-0000000, 000000-0******
- 연락처 탐지: 010-0000-0000, 02-000-0000
- 이메일 탐지: example@domain.com
- 주소 탐지: 도로명주소, 지번주소
- 시설명 탐지: "OO요양원", "행복복지관" 등
- 이름 탐지: 한국 성씨 + 2-4자 이름
```

**핵심 알고리즘:**
- **한국 성씨 데이터베이스**: 100개 주요 성씨 (김, 이, 박, 최...)
- **시설 키워드**: 요양원, 복지관, 센터, 의원, 병원 등 27개
- **정규표현식 패턴**: 전화번호, 이메일, 주민번호, 주소
- **일관성 매핑**: Map 자료구조로 동일 정보 → 동일 익명 코드

**익명화 순서 (중요!):**
1. 주민등록번호 (가장 먼저)
2. 연락처
3. 이메일
4. 주소
5. 시설명
6. 이름 (가장 마지막)

→ 순서가 중요한 이유: 이름을 먼저 처리하면 "김치", "이상" 같은 일반 단어도 이름으로 오탐지될 수 있음

#### `documentParser.js`
**다양한 문서 형식 지원**

```javascript
// 지원 형식
- DOCX: mammoth 라이브러리 사용
- PDF: pdf-parse 라이브러리 사용
- TXT: fs.readFile (UTF-8)

// 반환 데이터
{
  text: "추출된 텍스트",
  metadata: {
    format: 'docx|pdf|txt',
    pages: 5, // PDF만
    encoding: 'utf-8'
  }
}
```

---

### 2. 프론트엔드

#### `anonymization.html`
**사용자 인터페이스**

**주요 UI 요소:**
- 📤 **드래그 앤 드롭 업로드 영역**
- 📊 **통계 카드**: 이름, 시설, 연락처, 주소 개수
- 📝 **익명화된 텍스트 표시**: Monospace 폰트로 원본과 비교 가능
- 📋 **매핑 테이블**: 원본 ↔ 익명화 대응표 (카테고리별 색상 구분)
- 💾 **다운로드 버튼**: TXT, CSV 형식

#### `anonymization.js`
**프론트엔드 로직**

```javascript
// 파일 업로드 → API 호출 → 결과 표시
1. 파일 선택/드래그 앤 드롭
2. 유효성 검사 (형식, 크기)
3. FormData로 /api/anonymize-document POST
4. 응답 데이터 파싱
5. 익명화된 텍스트 + 매핑 테이블 렌더링
6. 다운로드 기능 제공
```

---

### 3. API 엔드포인트

#### `POST /api/anonymize-document`

**Request:**
```http
POST /api/anonymize-document
Content-Type: multipart/form-data
Authorization: Bearer {token}

document: [파일]
```

**Response:**
```json
{
  "success": true,
  "originalText": "원본 텍스트...",
  "anonymizedText": "익명화된 텍스트...",
  "mappings": {
    "names": [
      { "original": "박순자", "anonymized": "[인물_1]" },
      { "original": "이영희", "anonymized": "[인물_2]" }
    ],
    "facilities": [
      { "original": "행복요양원", "anonymized": "[시설_1]" }
    ],
    "phones": [
      { "original": "010-1234-5678", "anonymized": "[연락처_1]" }
    ],
    "addresses": [
      { "original": "서울시 강남구 테헤란로 123", "anonymized": "[주소_1]" }
    ],
    "emails": [
      { "original": "test@example.com", "anonymized": "[이메일_1]" }
    ],
    "residentIds": [
      { "original": "450123-2123456", "anonymized": "[주민번호_1]" }
    ]
  },
  "stats": {
    "names": 2,
    "facilities": 1,
    "phones": 1,
    "addresses": 1,
    "emails": 1,
    "residentIds": 1
  },
  "metadata": {
    "format": "txt"
  }
}
```

---

## 📖 사용 방법

### 1. 웹 브라우저 접속
```
https://3000-ixy5t1tdycwtc8cmz10wu-18e660f9.sandbox.novita.ai
```

### 2. 로그인
- 관리자 계정: `admin@casenetai.com` / `admin123`
- 또는 일반 사용자 계정

### 3. 메인 페이지에서 "문서 익명화" 클릭
🔐 아이콘의 카드를 클릭

### 4. 문서 업로드
- **방법 1**: 파일 선택 버튼 클릭
- **방법 2**: 드래그 앤 드롭

**지원 형식:**
- `.docx` (Microsoft Word)
- `.pdf` (PDF 문서)
- `.txt` (텍스트 파일)

**파일 크기 제한:** 10MB

### 5. 익명화 시작
"익명화 시작" 버튼 클릭

### 6. 결과 확인
- **통계 카드**: 탐지된 개인정보 개수
- **익명화된 텍스트**: 실시간 확인
- **매핑 테이블**: 원본 ↔ 익명화 대응표

### 7. 다운로드
- **익명화된 텍스트**: TXT 파일로 다운로드
- **매핑 테이블**: CSV 파일로 다운로드

---

## 💡 예시

### 입력 문서 (test_document.txt)
```
노인보호전문기관 상담일지

[신고자 정보]
신고자: 이영희 (010-1234-5678)
관계: 딸
주소: 서울시 강남구 테헤란로 123

[피해노인 정보]
성명: 박순자
주민등록번호: 450123-2123456
연령: 79세
연락처: 010-9876-5432

[시설 정보]
시설명: 행복요양원
시설장: 정수현 (031-123-4567)
```

### 익명화된 결과
```
노인보호전문기관 상담일지

[신고자 정보]
신고자: [인물_1] ([연락처_1])
관계: 딸
주소: [주소_1]

[피해노인 정보]
성명: [인물_2]
주민등록번호: [주민번호_1]
연령: 79세
연락처: [연락처_2]

[시설 정보]
시설명: [시설_1]
시설장: [인물_3] ([연락처_3])
```

### 매핑 테이블 (CSV)
```csv
구분,원본,익명화
이름,"이영희","[인물_1]"
이름,"박순자","[인물_2]"
이름,"정수현","[인물_3]"
시설,"행복요양원","[시설_1]"
연락처,"010-1234-5678","[연락처_1]"
연락처,"010-9876-5432","[연락처_2]"
연락처,"031-123-4567","[연락처_3]"
주소,"서울시 강남구 테헤란로 123","[주소_1]"
주민번호,"450123-2123456","[주민번호_1]"
```

---

## 🔒 보안 고려사항

### 데이터 보호
1. **서버 측 파일 즉시 삭제**: API 처리 후 업로드된 파일 자동 삭제
2. **메모리 내 처리**: 익명화 매핑은 요청마다 초기화
3. **로컬 다운로드**: 익명화된 결과는 브라우저에서 직접 다운로드

### 매핑 테이블 관리
⚠️ **중요**: 매핑 테이블은 **반드시 안전하게 보관**하세요!
- AI 분석 후 원본 복원 시 필요
- 타인에게 공유 금지
- 업무 완료 후 안전하게 삭제

---

## 🚀 향후 개선 사항

### 1. 추가 탐지 패턴
- [ ] 외국인 이름 (영문 이름)
- [ ] 차량번호
- [ ] 계좌번호
- [ ] 여권번호

### 2. 고급 기능
- [ ] **배치 처리**: 여러 파일 동시 익명화
- [ ] **커스텀 규칙**: 사용자 정의 탐지 패턴
- [ ] **익명화 수준 조절**: 이름만, 연락처만 등 선택 가능
- [ ] **AI 검증**: 규칙 기반 + AI 이중 검증

### 3. UI 개선
- [ ] 실시간 미리보기 (업로드 전)
- [ ] 원본 ↔ 익명화 비교 뷰
- [ ] 매핑 테이블 Excel 내보내기
- [ ] 익명화 전후 Word 문서 비교

---

## 📦 의존성

```json
{
  "mammoth": "^1.6.0",    // DOCX 파싱
  "pdf-parse": "^1.1.1"   // PDF 파싱
}
```

---

## 🧪 테스트

### 샘플 문서 생성
```bash
# test_document.txt 사용
/home/user/webapp/test_document.txt
```

### API 직접 테스트
```bash
curl -X POST http://localhost:3000/api/anonymize-document \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "document=@test_document.txt"
```

---

## 📝 커밋 정보

- **커밋 해시**: `792107d`
- **브랜치**: `genspark_ai_developer`
- **파일 변경**: 9개 (1,454줄 추가)

**주요 파일:**
- `services/anonymizationService.js` (298줄)
- `services/documentParser.js` (93줄)
- `public/anonymization.html` (241줄)
- `public/js/anonymization.js` (302줄)
- `server.js` (+107줄)

---

## 🎓 참고 자료

### 개인정보 보호법
- 노인복지법 제39조의6 (금지행위)
- 개인정보 보호법 제2조 (정의)
- 노인학대범죄의 처벌 등에 관한 특례법

### 관련 문서
- `GEMINI_GEMS_INSTRUCTION_V2.md`: 상담일지 생성 지침
- `TXT_FORMAT_CHANGE.md`: TXT 다운로드 형식
- `ADMIN_ACCOUNT_GUIDE.md`: 관리자 계정 가이드

---

## 👥 기여자

**개발자**: GenSpark AI Developer  
**프로젝트**: CaseNetAI by WellPartners  
**날짜**: 2025-12-06  

**감사의 말씀**  
이 기능은 노인보호전문기관 종사자의 현장 경험과 피드백을 바탕으로 개발되었습니다. 사회복지 업무의 효율성과 개인정보 보호를 동시에 달성하고자 하는 목표로 만들어졌습니다.

---

## 📞 문의

기능 개선 제안이나 버그 리포트는 GitHub Issues를 이용해주세요.

**Repository**: `YUNHYEONJUN/casenetai`  
**Branch**: `genspark_ai_developer`
