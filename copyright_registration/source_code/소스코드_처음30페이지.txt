========================================
CaseNetAI ì†ŒìŠ¤ì½”ë“œ (ì²˜ìŒ 30í˜ì´ì§€)
ì €ì‘ê¶Œì: ìœ¤í˜„ì¤€
ì‘ì„±ì¼: 2026ë…„ 01ì›” 21ì¼
========================================

========================================
íŒŒì¼ 1: server.js (ë©”ì¸ ì„œë²„)
========================================
require('dotenv').config();
const express = require('express');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const cors = require('cors');
const aiService = require('./services/aiService');
const creditService = require('./services/creditService');
const { optionalAuth } = require('./middleware/auth');

// í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
const requiredEnvVars = ['DATABASE_URL', 'JWT_SECRET'];
const missingEnvVars = requiredEnvVars.filter(varName => !process.env[varName]);
if (missingEnvVars.length > 0) {
  console.error('âŒ í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:', missingEnvVars.join(', '));
  console.error('   .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  process.exit(1);
}

// JWT_SECRET ê°•ë„ ê²€ì¦
if (process.env.JWT_SECRET && process.env.JWT_SECRET.length < 32) {
  console.warn('âš ï¸  ê²½ê³ : JWT_SECRETì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ (ìµœì†Œ 32ì ê¶Œì¥)');
}

const app = express();
const PORT = process.env.PORT || 3000;

// ë³´ì•ˆ í—¤ë” ì„¤ì • (Helmet)
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.openai.com", "https://*.supabase.co"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Rate Limiting (DDoS ë°©ì–´)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// ì¼ë°˜ API Rate Limiter (15ë¶„ë‹¹ 100íšŒ)
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15ë¶„
  max: 100, // ìµœëŒ€ 100íšŒ ìš”ì²­
  message: {
    success: false,
    error: 'ë„ˆë¬´ ë§ì€ ìš”ì²­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  },
  standardHeaders: true,
  legacyHeaders: false,
  skip: (req) => {
    // í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ëŠ” rate limit ì œì™¸
    return req.path === '/api/status' || req.path === '/api/anonymization/health';
  }
});

// ë¡œê·¸ì¸ Rate Limiter (15ë¶„ë‹¹ 5íšŒ - ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ë°©ì–´)
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: {
    success: false,
    error: 'ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. 15ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  },
  skipSuccessfulRequests: true, // ì„±ê³µí•œ ìš”ì²­ì€ ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ
});

// ìµëª…í™” API Rate Limiter (1ë¶„ë‹¹ 10íšŒ - ê³¼ë„í•œ ì‚¬ìš© ë°©ì§€)
const anonymizationLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 10,
  message: {
    success: false,
    error: 'ìµëª…í™” ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  },
});

// Middleware
// CORS ì„¤ì • - ë³´ì•ˆ ê°•í™”
const corsOptions = {
  origin: function (origin, callback) {
    // í—ˆìš©í•  ë„ë©”ì¸ ëª©ë¡
    const allowedOrigins = [
      'http://localhost:3000',
      'http://localhost:3001',
      'https://casenetai.kr',
      'https://www.casenetai.kr',
      'https://casenetai.com',
      'https://www.casenetai.com',
      process.env.ALLOWED_ORIGIN // í™˜ê²½ ë³€ìˆ˜ë¡œ ì¶”ê°€ ë„ë©”ì¸ ì„¤ì • ê°€ëŠ¥
    ].filter(Boolean);
    
    // originì´ undefinedì¸ ê²½ìš° (ê°™ì€ ë„ë©”ì¸, Vercel serverless) ë˜ëŠ” í—ˆìš© ëª©ë¡ì— ìˆëŠ” ê²½ìš° í—ˆìš©
    if (!origin || allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      console.warn('âš ï¸  CORS ì°¨ë‹¨:', origin);
      // í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œë§Œ ì—„ê²©í•˜ê²Œ ì²´í¬
      if (process.env.NODE_ENV === 'production') {
        callback(new Error('CORS ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'));
      } else {
        callback(null, true);
      }
    }
  },
  credentials: true, // ì¿ í‚¤ ë“± ì¸ì¦ ì •ë³´ í—ˆìš©
  optionsSuccessStatus: 200,
  maxAge: 86400 // Preflight ìºì‹œ 24ì‹œê°„
};

app.use(cors(corsOptions));
app.use(express.json({ limit: '10mb' })); // JSON í˜ì´ë¡œë“œ í¬ê¸° ì œí•œ
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(express.static('public'));

// ì „ì—­ Rate Limiter ì ìš©
app.use('/api/', apiLimiter);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ì¸ì¦ & ê²°ì œ & ê´€ë¦¬ì & í”¼ë“œë°± & ë¶„ì„ & 3ë‹¨ê³„ ê¶Œí•œ ë¼ìš°í„°
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const authRouter = require('./routes/auth');
const paymentRouter = require('./routes/payment');
const adminRouter = require('./routes/admin');
const feedbackRouter = require('./routes/feedback');
const analyticsRouter = require('./routes/analytics');

// 3ë‹¨ê³„ ê¶Œí•œ ì‹œìŠ¤í…œ ë¼ìš°í„°
const systemAdminRouter = require('./routes/system-admin');
const orgAdminRouter = require('./routes/org-admin');
const joinRequestsRouter = require('./routes/join-requests');
const systemAdminDashboardRouter = require('./routes/system-admin-dashboard');

// ì§„ìˆ ì„œ ë¼ìš°í„°
const statementRouter = require('./routes/statement');

// ë…¸ì¸ë³µì§€ì‹œì„¤ ë¼ìš°í„°
const welfareFacilitiesRouter = require('./routes/welfare-facilities');

app.use('/api/auth', authRouter);
app.use('/api/payment', paymentRouter);
app.use('/api/admin', adminRouter);
app.use('/api/feedback', feedbackRouter);
app.use('/api/analytics', analyticsRouter);

// 3ë‹¨ê³„ ê¶Œí•œ ì‹œìŠ¤í…œ API
app.use('/api/system-admin', systemAdminRouter);
app.use('/api/org-admin', orgAdminRouter);
app.use('/api/join-requests', joinRequestsRouter);
app.use('/api/system-admin-dashboard', systemAdminDashboardRouter);

// ì§„ìˆ ì„œ API
app.use('/api/statement', statementRouter);

// ë…¸ì¸ë³µì§€ì‹œì„¤ API
app.use('/api/welfare-facilities', welfareFacilitiesRouter);

// Multer ì„¤ì • (ìŒì„± íŒŒì¼ ì—…ë¡œë“œ)
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, 'uploads/');
  },
  filename: function (req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    // ê²½ë¡œ íƒìƒ‰ ê³µê²© ë°©ì§€: basenameìœ¼ë¡œ íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
    const safeExtname = path.extname(path.basename(file.originalname));
    cb(null, file.fieldname + '-' + uniqueSuffix + safeExtname);
  }
});

const upload = multer({
  storage: storage,
  limits: { 
    fileSize: 100 * 1024 * 1024, // 100MB ì œí•œ
    files: 1 // íŒŒì¼ ê°œìˆ˜ ì œí•œ
  },
  fileFilter: function (req, file, cb) {
    // íŒŒì¼ëª… ë³´ì•ˆ ê²€ì¦
    const basename = path.basename(file.originalname);
    if (basename.includes('..') || basename.includes('/') || basename.includes('\\\\')) {
      return cb(new Error('ì˜ëª»ëœ íŒŒì¼ëª…ì…ë‹ˆë‹¤.'));
    }
    
    const allowedTypes = /mp3|wav|m4a|ogg|webm|mp4/;
    const allowedMimes = ['audio/mpeg', 'audio/wav', 'audio/x-wav', 'audio/m4a', 'audio/x-m4a', 
                          'audio/ogg', 'audio/webm', 'video/mp4', 'video/webm'];
    
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());

========================================
íŒŒì¼ 2: routes/auth.js (ì¸ì¦)
========================================
/**
 * ì¸ì¦ ê´€ë ¨ ë¼ìš°í„°
 */

const express = require('express');
const rateLimit = require('express-rate-limit');
const router = express.Router();
const authService = require('../services/authService');
const { authenticateToken } = require('../middleware/auth');
const passport = require('../config/passport');
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET || 'casenetai-secret-key-change-in-production';
const JWT_EXPIRES_IN = '7d';

// ë¡œê·¸ì¸ ì‹œë„ ì œí•œ (ë¸Œë£¨íŠ¸í¬ìŠ¤ ê³µê²© ë°©ì–´)
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15ë¶„
  max: 5, // ìµœëŒ€ 5íšŒ ì‹œë„
  skipSuccessfulRequests: true, // ì„±ê³µí•œ ìš”ì²­ì€ ì¹´ìš´íŠ¸ ì•ˆí•¨
  message: {
    success: false,
    error: 'ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. 15ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// íšŒì›ê°€ì… (ê´€ë¦¬ì ì „ìš© - ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

router.post('/register', async (req, res) => {
  try {
    const { email, password, name, phone, organizationId, masterPassword, role, credits } = req.body;
    
    // ğŸ” ê´€ë¦¬ì ì „ìš©: ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    const MASTER_PASSWORD = process.env.MASTER_PASSWORD || 'CaseNetAI2026!@#';
    if (masterPassword !== MASTER_PASSWORD) {
      return res.status(403).json({
        success: false,
        error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
      });
    }
    
    // ì…ë ¥ ê²€ì¦
    if (!email || !password || !name) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'
      });
    }
    
    // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({
        success: false,
        error: 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤'
      });
    }
    
    // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦
    if (password.length < 8) {
      return res.status(400).json({
        success: false,
        error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'
      });
    }
    
    // ë¹„ë°€ë²ˆí˜¸ ë³µì¡ë„ ê²€ì¦ (ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ)
    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    const complexityCount = [hasLetter, hasNumber, hasSpecial].filter(Boolean).length;
    
    if (complexityCount < 2) {
      return res.status(400).json({
        success: false,
        error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤'
      });
    }
    
    // ğŸ” ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ê³„ì • ìƒì„±
    const result = await authService.registerWithRole({
      email,
      password,
      name,
      phone,
      organizationId,
      role: role || 'system_admin',  // ê¸°ë³¸ê°’: system_admin
      credits: credits || 10000000,  // ê¸°ë³¸ê°’: 10,000,000ì›
      serviceType: req.body.serviceType || 'elderly_protection'
    });
    
    res.json(result);
    
  } catch (error) {
    console.error('âŒ íšŒì›ê°€ì… API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ë¡œê·¸ì¸ (DEPRECATED - ì†Œì…œ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒ€ì²´)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

router.post('/login', loginLimiter, async (req, res) => {
  // âš ï¸ DEPRECATED: ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” ê³§ ì œê±°ë  ì˜ˆì •ì…ë‹ˆë‹¤
  // ì†Œì…œ ë¡œê·¸ì¸(ì¹´ì¹´ì˜¤/ë„¤ì´ë²„)ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”
  try {
    const { email, password } = req.body;
    
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        error: 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'
      });
    }
    
    const result = await authService.login({
      email,
      password,
      ipAddress: req.ip,
      userAgent: req.get('user-agent')
    });
    
    res.json(result);
    
  } catch (error) {
    console.error('âŒ ë¡œê·¸ì¸ API ì˜¤ë¥˜:', error);
    res.status(401).json({
      success: false,
      error: error.message
    });
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ë¡œê·¸ì•„ì›ƒ
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

router.post('/logout', authenticateToken, async (req, res) => {
  try {
    const token = req.headers['authorization'].split(' ')[1];
    const result = await authService.logout(token);
    res.json(result);
  } catch (error) {
    console.error('âŒ ë¡œê·¸ì•„ì›ƒ API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// í† í° ê°±ì‹ 
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

router.post('/refresh', async (req, res) => {
  try {
    const { refreshToken } = req.body;
    
    if (!refreshToken) {
      return res.status(400).json({
        success: false,
        error: 'ë¦¬í”„ë ˆì‹œ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤'
      });
    }
    
    const result = await authService.refreshToken(refreshToken);
    res.json(result);
    
  } catch (error) {
    console.error('âŒ í† í° ê°±ì‹  API ì˜¤ë¥˜:', error);
    res.status(401).json({
      success: false,
      error: error.message
    });
  }
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ë‚´ ì •ë³´ ì¡°íšŒ
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

router.get('/me', authenticateToken, async (req, res) => {
  try {
    const result = await authService.getUserInfo(req.user.userId);
    res.json(result);
  } catch (error) {
    console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

========================================
íŒŒì¼ 3: services/authService.js
========================================
/**
 * ì¸ì¦ ì„œë¹„ìŠ¤
 * - íšŒì›ê°€ì…, ë¡œê·¸ì¸, JWT í† í° ê´€ë¦¬
 */

const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const { getDB } = require('../database/db-postgres');

// JWT_SECRET í•„ìˆ˜ ê²€ì¦
if (!process.env.JWT_SECRET) {
  throw new Error('âŒ JWT_SECRET í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.');
}

const JWT_SECRET = process.env.JWT_SECRET;
const JWT_EXPIRES_IN = '1h'; // 1ì‹œê°„ (ë³´ì•ˆ ê°•í™”)
const REFRESH_TOKEN_EXPIRES_IN = '7d'; // 7ì¼
const SALT_ROUNDS = 12; // ë³´ì•ˆ ê°•í™” (10 â†’ 12)

class AuthService {
  
  /**
   * íšŒì›ê°€ì…
   */
  async register({ email, password, name, phone, organizationId = null, serviceType = 'elderly_protection' }) {
    const db = getDB();
    
    try {
      // ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
      const existingUser = await db.get(
        'SELECT id FROM users WHERE oauth_email = $1',
        [email]
      );
      
      if (existingUser) {
        throw new Error('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤');
      }
      
      // ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ
      const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);
      
      // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‚¬ìš©ì ìƒì„± ë° í¬ë ˆë”§ ì´ˆê¸°í™”
      const result = await db.transaction(async (client) => {
        // ì‚¬ìš©ì ìƒì„±
        const userResult = await client.query(
          `INSERT INTO users (oauth_email, name, phone, organization_id, service_type, oauth_provider, oauth_id)
           VALUES ($1, $2, $3, $4, $5, 'local', $6) RETURNING id`,
          [email, name, phone, organizationId, serviceType, 'legacy_' + Date.now()]
        );
        
        const userId = userResult.rows[0].id;
        
        // í¬ë ˆë”§ ì´ˆê¸°í™” (ë¬´ë£Œ ì²´í—˜ 3íšŒ)
        await client.query(
          `INSERT INTO credits (user_id, balance, free_trial_count)
           VALUES ($1, 0, 3)`,
          [userId]
        );
        
        return userId;
      });
      
      console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ:', email);
      
      return {
        success: true,
        userId: result,
        message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'
      };
      
    } catch (error) {
      console.error('âŒ íšŒì›ê°€ì… ì‹¤íŒ¨:', error.message);
      throw error;
    }
  }
  
  /**
   * ê´€ë¦¬ì ì „ìš©: ì—­í•  ë° í¬ë ˆë”§ ì„¤ì • ê°€ëŠ¥í•œ íšŒì›ê°€ì…
   */
  async registerWithRole({ email, password, name, phone, organizationId = null, role = 'system_admin', credits = 10000000, serviceType = 'elderly_protection' }) {
    const db = getDB();
    
    try {
      // ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
      const existingUser = await db.get(
        'SELECT id FROM users WHERE oauth_email = $1',
        [email]
      );
      
      if (existingUser) {
        throw new Error('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤');
      }
      
      // ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ
      const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);
      
      // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‚¬ìš©ì ìƒì„± ë° í¬ë ˆë”§ ì´ˆê¸°í™”
      const userId = await db.transaction(async (client) => {
        // ì‚¬ìš©ì ìƒì„± (ê´€ë¦¬ì ê¶Œí•œ í¬í•¨)
        const userResult = await client.query(
          `INSERT INTO users (oauth_email, name, phone, organization_id, service_type, oauth_provider, oauth_id, role, is_approved)
           VALUES ($1, $2, $3, $4, $5, 'local', $6, $7, true) RETURNING id`,
          [email, name, phone, organizationId, serviceType, 'admin_' + Date.now(), role]
        );
        
        const newUserId = userResult.rows[0].id;
        
        // í¬ë ˆë”§ ì´ˆê¸°í™” (ê´€ë¦¬ì ì§€ì • ê¸ˆì•¡)
        await client.query(
          `INSERT INTO credits (user_id, balance, free_trial_count)
           VALUES ($1, $2, 0)`,
          [newUserId, credits]
        );
        
        return newUserId;
      });
      
      console.log(`âœ… ê´€ë¦¬ì ê³„ì • ìƒì„± ì„±ê³µ: ${email} (${role}, ${credits}ì›)`);
      
      return {
        success: true,
        userId: userId,
        role: role,
        credits: credits,
        message: 'ê´€ë¦¬ì ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'
      };
      
    } catch (error) {
      console.error('âŒ ê´€ë¦¬ì ê³„ì • ìƒì„± ì‹¤íŒ¨:', error.message);
      throw error;
    }
  }
  
  /**
   * ë¡œê·¸ì¸
   */
  async login({ email, password, ipAddress, userAgent }) {
    const db = getDB();
    
    try {
      // ì‚¬ìš©ì ì¡°íšŒ
      const user = await db.get(
        `SELECT id, oauth_email as email, name, role, organization_id, service_type
         FROM users WHERE oauth_email = $1`,
        [email]
      );
      
      if (!user) {
        throw new Error('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
      }
