<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>노인보호전문기관 - CaseNetAI</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        // 즉시 실행 인증 체크 (페이지 로드 전)
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
            }
        })();
    </script>
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1><a href="/" style="color: inherit; text-decoration: none;">CaseNetAI</a></h1>
                    <p class="tagline">노인보호전문기관</p>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">홈</a>
                    <a href="#about" class="nav-link">서비스 소개</a>
                    <a href="#features" class="nav-link">주요 기능</a>
                    <a href="#upload" class="nav-link">상담일지 생성</a>
                    <a href="#anonymization" class="nav-link">문서 익명화</a>
                    <a href="/dashboard.html" class="nav-link" id="dashboardLink" style="display:none;">대시보드</a>
                    <a href="/login.html" class="nav-link" id="loginLink">로그인</a>
                    <a href="/register.html" class="nav-link" id="registerLink" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 6px;">무료 시작</a>
                    <a href="#" class="nav-link" id="logoutLink" style="display:none;" onclick="logout(); return false;">로그아웃</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- 히어로 섹션 -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h2 class="hero-title">상담 녹음을 자동으로 상담일지로</h2>
                <p class="hero-subtitle">AI 기술로 노인보호전문기관의 상담일지 작성을 자동화합니다</p>
                <a href="#upload" class="btn btn-primary btn-large">지금 시작하기</a>
            </div>
        </div>
    </section>

    <!-- 서비스 소개 -->
    <section id="about" class="section about">
        <div class="container">
            <h2 class="section-title">서비스 소개</h2>
            <div class="about-content">
                <div class="about-card">
                    <div class="about-icon">✓</div>
                    <h3>정확한 기록</h3>
                    <p>노인보호전문기관 업무수행지침에 따른 정확한 상담일지 양식</p>
                </div>
                <div class="about-card">
                    <div class="about-icon">⏱</div>
                    <h3>시간 절약</h3>
                    <p>수작업 기록 시간을 90% 이상 단축</p>
                </div>
                <div class="about-card">
                    <div class="about-icon">⬢</div>
                    <h3>안전한 보안</h3>
                    <p>개인정보 보호를 위한 철저한 보안 시스템</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 주요 기능 -->
    <section id="features" class="section features">
        <div class="container">
            <h2 class="section-title">주요 기능</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-number">01</div>
                    <h3>음성 파일 업로드</h3>
                    <p>전화상담, 방문상담, 내방상담의 녹음 파일을 업로드합니다</p>
                </div>
                <div class="feature-card">
                    <div class="feature-number">02</div>
                    <h3>자동 텍스트 변환</h3>
                    <p>AI 음성인식 기술로 녹음 내용을 정확하게 텍스트로 변환합니다</p>
                </div>
                <div class="feature-card">
                    <div class="feature-number">03</div>
                    <h3>상담일지 자동 생성</h3>
                    <p>변환된 텍스트를 분석하여 표준 양식의 상담일지를 자동으로 생성합니다</p>
                </div>
                <div class="feature-card">
                    <div class="feature-number">04</div>
                    <h3>검토 및 수정</h3>
                    <p>생성된 상담일지를 검토하고 필요한 부분을 수정할 수 있습니다</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 업로드 섹션 -->
    <section id="upload" class="section upload-section">
        <div class="container">
            <h2 class="section-title">상담일지 자동 생성</h2>
            <div class="upload-container">
                <div class="upload-form">
                    <div class="form-group">
                        <label for="consultationType">상담 방식</label>
                        <select id="consultationType" class="form-control">
                            <option value="">선택해주세요</option>
                            <option value="phone">전화상담</option>
                            <option value="visit">방문상담</option>
                            <option value="office">내방상담</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="consultationStage">상담 단계</label>
                        <select id="consultationStage" class="form-control">
                            <option value="">선택해주세요</option>
                            <option value="intake">접수상담 (초기 정보 수집)</option>
                            <option value="ongoing">진행상담 (기존 사례 추가 상담)</option>
                            <option value="closure">종결상담 (사례 종료 관련)</option>
                            <option value="simple">단순문의 (간단한 전화 상담)</option>
                        </select>
                        <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
                            💡 <strong>접수상담</strong>: 모든 정보 입력 | <strong>진행상담</strong>: 새로운 내용만 입력 | <strong>종결상담</strong>: 마무리 정보 | <strong>단순문의</strong>: 간단한 기록
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="audioFile">녹음 파일 업로드</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="audioFile" accept="audio/*,video/mp4" class="file-input">
                            <label for="audioFile" class="file-label">
                                <span class="file-icon">📁</span>
                                <span class="file-text">파일을 선택하거나 드래그하세요</span>
                                <span class="file-info">지원 형식: MP3, WAV, M4A, OGG, WebM, MP4 (최대 100MB)</span>
                            </label>
                        </div>
                        <div id="fileName" class="file-name"></div>
                    </div>

                    <div id="statusMessage" class="status-message" style="margin-bottom: 1rem; padding: 1rem; background: #fff3cd; border-radius: 0.5rem; display: none;">
                        <strong>⚠️ 버튼을 활성화하려면:</strong><br>
                        1️⃣ 상담 방식을 선택하세요<br>
                        2️⃣ 상담 단계를 선택하세요<br>
                        3️⃣ 음성 파일을 업로드하세요
                    </div>
                    
                    <button id="uploadBtn" class="btn btn-primary btn-large" disabled>
                        상담일지 생성하기
                    </button>

                    <!-- 비용 확인 정보 표시 -->
                    <div id="costInfoContainer" class="cost-info-container" style="display: none; margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0.75rem; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h4 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">💰</span>
                                <span>예상 비용</span>
                            </h4>
                            <div id="analyzingBadge" style="display: none; background: rgba(255,255,255,0.2); padding: 0.3rem 0.8rem; border-radius: 1rem; font-size: 0.85rem;">
                                <span class="spinner" style="display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                                <span style="margin-left: 0.5rem;">분석 중...</span>
                            </div>
                        </div>
                        
                        <div id="costDetails" style="background: rgba(255,255,255,0.15); padding: 1.2rem; border-radius: 0.5rem; backdrop-filter: blur(10px);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.3rem;">📏 파일 크기</div>
                                    <div id="fileSize" style="font-size: 1.1rem; font-weight: 600;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.3rem;">⏱️ 녹음 길이</div>
                                    <div id="audioDuration" style="font-size: 1.1rem; font-weight: 600;">-</div>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 1rem; margin-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.95rem; opacity: 0.9;">음성 인식 (STT)</span>
                                    <span id="sttCost" style="font-size: 1.05rem; font-weight: 600;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.8rem;">
                                    <span style="font-size: 0.95rem; opacity: 0.9;">AI 분석</span>
                                    <span id="aiCost" style="font-size: 1.05rem; font-weight: 600;">무료 ~ 12원</span>
                                </div>
                                <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 0.8rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1.1rem; font-weight: 700;">총 예상 비용</span>
                                    <span id="totalCost" style="font-size: 1.5rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.8rem; background: rgba(255,255,255,0.1); border-radius: 0.5rem; font-size: 0.9rem; line-height: 1.5;">
                            <div style="display: flex; align-items: flex-start;">
                                <span style="margin-right: 0.5rem;">ℹ️</span>
                                <div>
                                    <div>• OpenAI Whisper STT 사용 (1순위)</div>
                                    <div>• Google Gemini AI 분석 무료 (1순위)</div>
                                    <div>• 실제 비용은 처리 완료 후 확인 가능</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="progressContainer" class="progress-container" style="display: none;">
                        <div class="progress-bar">
                            <div id="progressBar" class="progress-fill"></div>
                        </div>
                        <p id="progressText" class="progress-text">파일 업로드 중...</p>
                    </div>
                </div>

                <!-- 결과 표시 영역 -->
                <div id="resultContainer" class="result-container" style="display: none;">
                    <div class="result-header">
                        <h3>생성된 상담일지</h3>
                        <div class="result-actions">
                            <button id="editBtn" class="btn btn-secondary">수정</button>
                            <button id="downloadBtn" class="btn btn-primary">TXT 다운로드</button>
                        </div>
                    </div>
                    <div id="reportContent" class="report-content">
                        <!-- 상담일지 내용이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 문서 익명화 섹션 -->
    <section id="anonymization" class="section" style="background: #f8f9fa;">
        <div class="container">
            <div class="section-header">
                <h2>문서 익명화</h2>
                <p>개인정보가 포함된 문서를 안전하게 익명화하세요 (AI API 불필요)</p>
            </div>

            <div class="upload-container">
                <div class="upload-box" id="docUploadArea" style="border: 3px dashed #667eea; padding: 40px; text-align: center; background: white; border-radius: 15px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 40px; color: #667eea; margin-bottom: 20px; font-weight: bold;">문서</div>
                    <h3>문서를 드래그하거나 클릭하여 업로드</h3>
                    <p style="color: #6c757d; margin-top: 10px;">지원 형식: DOCX, PDF, TXT (최대 10MB)</p>
                    <input type="file" id="documentInput" accept=".docx,.pdf,.txt" style="display: none;">
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="document.getElementById('documentInput').click()">
                        파일 선택
                    </button>
                </div>

                <div id="docFileInfo" style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #dee2e6;">
                    <p style="margin: 0;"><strong>선택된 파일:</strong> <span id="docFileName"></span> <span id="docFileSize" style="color: #667eea;"></span></p>
                    <button class="btn btn-success" style="margin-top: 15px; width: 100%;" onclick="processAnonymization()">
                        익명화 시작
                    </button>
                </div>
            </div>

            <!-- 익명화 결과 -->
            <div id="anonymizationResult" style="display: none; margin-top: 40px;">
                <!-- 통계 카드 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">이름</div>
                        <div id="statNames" style="font-size: 32px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">시설</div>
                        <div id="statFacilities" style="font-size: 32px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">연락처</div>
                        <div id="statPhones" style="font-size: 32px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">주소</div>
                        <div id="statAddresses" style="font-size: 32px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                </div>

                <!-- 익명화된 텍스트 -->
                <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">익명화된 문서</h3>
                        <div>
                            <button class="btn btn-secondary" onclick="copyAnonymizedText()" style="margin-right: 10px;">
                                복사
                            </button>
                            <button class="btn btn-primary" onclick="downloadAnonymizedDoc()">
                                TXT 다운로드
                            </button>
                        </div>
                    </div>
                    <div id="anonymizedText" style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; border: 1px solid #dee2e6;"></div>
                </div>

                <!-- 매핑 테이블 -->
                <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">익명화 매핑 테이블</h3>
                        <button class="btn btn-primary" onclick="downloadMappingTable()">
                            CSV 다운로드
                        </button>
                    </div>
                    <div id="mappingTableContainer"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>CaseNetAI</h3>
                    <p>Powered by <a href="https://wellpartners.kr" target="_blank">WellPartners</a></p>
                </div>
                <div class="footer-links">
                    <a href="#">이용약관</a>
                    <a href="#">개인정보처리방침</a>
                    <a href="#">고객센터</a>
                </div>
                <div class="footer-copyright">
                    <p>&copy; 2025 WellPartners. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/main.js?v=2025122601"></script>
    <script>
        // 로그아웃 함수
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            alert('로그아웃되었습니다.');
            window.location.href = '/';
        }

        // 로그인 상태 확인 및 UI 업데이트
        function updateAuthUI() {
            const token = localStorage.getItem('token');
            const loginLink = document.getElementById('loginLink');
            const registerLink = document.getElementById('registerLink');
            const logoutLink = document.getElementById('logoutLink');
            const dashboardLink = document.getElementById('dashboardLink');

            if (token) {
                // 로그인 상태
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutLink.style.display = 'inline-block';
                dashboardLink.style.display = 'inline-block';
            } else {
                // 로그아웃 상태
                loginLink.style.display = 'inline-block';
                registerLink.style.display = 'inline-block';
                logoutLink.style.display = 'none';
                dashboardLink.style.display = 'none';
            }
        }

        // 페이지 로드시 인증 UI 업데이트
        window.addEventListener('DOMContentLoaded', updateAuthUI);

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // 문서 익명화 기능
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        let currentDocFile = null;
        let anonymizedData = null;

        // 파일 업로드 UI 설정
        const docUploadArea = document.getElementById('docUploadArea');
        const documentInput = document.getElementById('documentInput');

        docUploadArea.addEventListener('click', () => documentInput.click());

        documentInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleDocFile(file);
        });

        // 드래그 앤 드롭
        docUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            docUploadArea.style.borderColor = '#764ba2';
            docUploadArea.style.background = '#f0f0f0';
        });

        docUploadArea.addEventListener('dragleave', () => {
            docUploadArea.style.borderColor = '#667eea';
            docUploadArea.style.background = 'white';
        });

        docUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            docUploadArea.style.borderColor = '#667eea';
            docUploadArea.style.background = 'white';
            const file = e.dataTransfer.files[0];
            if (file) handleDocFile(file);
        });

        function handleDocFile(file) {
            // 파일 크기 확인 (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('파일 크기는 10MB를 초과할 수 없습니다.');
                return;
            }

            // 파일 형식 확인
            const allowedTypes = ['.docx', '.pdf', '.txt'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(ext)) {
                alert('지원하지 않는 파일 형식입니다. (DOCX, PDF, TXT만 가능)');
                return;
            }

            currentDocFile = file;

            // 파일 정보 표시
            document.getElementById('docFileName').textContent = file.name;
            document.getElementById('docFileSize').textContent = formatFileSize(file.size);
            document.getElementById('docFileInfo').style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        async function processAnonymization() {
            if (!currentDocFile) {
                alert('파일을 먼저 선택해주세요.');
                return;
            }

            const formData = new FormData();
            formData.append('document', currentDocFile);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/anonymize-document', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '익명화 처리 중 오류가 발생했습니다.');
                }

                const data = await response.json();
                anonymizedData = data;

                // 결과 표시
                displayAnonymizationResults(data);

            } catch (error) {
                console.error('익명화 오류:', error);
                alert('오류: ' + error.message);
            }
        }

        function displayAnonymizationResults(data) {
            // 결과 섹션 표시
            document.getElementById('anonymizationResult').style.display = 'block';

            // 익명화된 텍스트 표시
            document.getElementById('anonymizedText').textContent = data.anonymizedText;

            // 통계 업데이트
            const mappings = data.mappings;
            document.getElementById('statNames').textContent = mappings.names?.length || 0;
            document.getElementById('statFacilities').textContent = mappings.facilities?.length || 0;
            document.getElementById('statPhones').textContent = mappings.phones?.length || 0;
            document.getElementById('statAddresses').textContent = mappings.addresses?.length || 0;

            // 매핑 테이블 생성
            createMappingTable(mappings);

            // 결과 섹션으로 스크롤
            document.getElementById('anonymizationResult').scrollIntoView({ behavior: 'smooth' });
        }

        function createMappingTable(mappings) {
            const container = document.getElementById('mappingTableContainer');
            let html = '';

            const categories = [
                { key: 'names', label: '이름', icon: '', color: '#667eea' },
                { key: 'facilities', label: '시설', icon: '', color: '#10b981' },
                { key: 'phones', label: '연락처', icon: '', color: '#3b82f6' },
                { key: 'addresses', label: '주소', icon: '', color: '#f59e0b' },
                { key: 'emails', label: '이메일', icon: '', color: '#6b7280' },
                { key: 'residentIds', label: '주민번호', icon: '', color: '#ef4444' }
            ];

            categories.forEach(cat => {
                const items = mappings[cat.key];
                if (items && items.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: ${cat.color}; margin-bottom: 15px;">
                                ${cat.icon} ${cat.label} (${items.length}개)
                            </h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 12px; text-align: left; width: 50px;">#</th>
                                        <th style="padding: 12px; text-align: left;">원본</th>
                                        <th style="padding: 12px; text-align: left;">익명화</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    items.forEach((item, index) => {
                        html += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 12px;">${index + 1}</td>
                                <td style="padding: 12px;"><code style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">${escapeHtml(item.original)}</code></td>
                                <td style="padding: 12px;"><strong style="color: ${cat.color};">${escapeHtml(item.anonymized)}</strong></td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });

            if (html === '') {
                html = '<div style="text-align: center; padding: 40px; color: #6c757d;">익명화된 항목이 없습니다.</div>';
            }

            container.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyAnonymizedText() {
            const text = document.getElementById('anonymizedText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('익명화된 텍스트가 클립보드에 복사되었습니다.');
            }).catch(err => {
                console.error('복사 실패:', err);
                alert('복사에 실패했습니다.');
            });
        }

        function downloadAnonymizedDoc() {
            if (!anonymizedData) return;

            const text = anonymizedData.anonymizedText;
            const blob = new Blob(['\ufeff' + text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `익명화_${currentDocFile.name.split('.')[0]}_${getDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function downloadMappingTable() {
            if (!anonymizedData) return;

            let csv = '\ufeff구분,원본,익명화\n';

            const mappings = anonymizedData.mappings;
            const categories = {
                'names': '이름',
                'facilities': '시설',
                'phones': '연락처',
                'addresses': '주소',
                'emails': '이메일',
                'residentIds': '주민번호'
            };

            Object.keys(categories).forEach(key => {
                const items = mappings[key];
                if (items && items.length > 0) {
                    items.forEach(item => {
                        csv += `${categories[key]},"${item.original}","${item.anonymized}"\n`;
                    });
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `매핑테이블_${getDateString()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function getDateString() {
            const now = new Date();
            return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
