<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Admin Dashboard - CaseNetAI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 5px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-card .subtitle {
      font-size: 13px;
      color: #95a5a6;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #2c3e50;
      border-bottom: 2px solid #e1e8ed;
      padding-bottom: 10px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e1e8ed;
    }

    .tab {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #7f8c8d;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #7f8c8d;
      border-bottom: 2px solid #e1e8ed;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f1f3f5;
      font-size: 14px;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge.danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e1e8ed;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }

    .progress-fill.danger {
      background: #e74c3c;
    }

    .progress-fill.warning {
      background: #f39c12;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .search-box {
      padding: 10px 15px;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-left: 10px;
      transition: background 0.3s;
    }

    .refresh-btn:hover {
      background: #5568d3;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #95a5a6;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¯ System Admin Dashboard</h1>
    <p>ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë° ì‚¬ìš© í˜„í™© ê´€ë¦¬</p>
  </div>

  <div class="container">
    <!-- Overview Stats -->
    <div id="overview-stats" class="stats-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>ë°ì´í„° ë¡œë”© ì¤‘...</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="section">
      <div class="tabs">
        <button class="tab active" data-tab="organizations">ê¸°ê´€ë³„ ì‚¬ìš© í˜„í™©</button>
        <button class="tab" data-tab="users">ê³„ì •ë³„ ì‚¬ìš© í˜„í™©</button>
        <button class="tab" data-tab="activity">ìµœê·¼ í™œë™</button>
      </div>

      <!-- ê¸°ê´€ë³„ ì‚¬ìš© í˜„í™© -->
      <div id="organizations" class="tab-content active">
        <input type="text" class="search-box" id="org-search" placeholder="ê¸°ê´€ëª… ê²€ìƒ‰...">
        <button class="refresh-btn" onclick="loadOrganizations()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <div id="organizations-content"></div>
      </div>

      <!-- ê³„ì •ë³„ ì‚¬ìš© í˜„í™© -->
      <div id="users" class="tab-content">
        <input type="text" class="search-box" id="user-search" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰...">
        <button class="refresh-btn" onclick="loadUsers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <div id="users-content"></div>
      </div>

      <!-- ìµœê·¼ í™œë™ -->
      <div id="activity" class="tab-content">
        <button class="refresh-btn" onclick="loadActivity()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <div id="activity-content"></div>
      </div>
    </div>
  </div>

  <script>
    // API Base URL
    const API_BASE = '/api/system-admin-dashboard';

    // Get token from localStorage
    function getToken() {
      return localStorage.getItem('token');
    }

    // API Call Helper
    async function apiCall(endpoint) {
      const token = getToken();
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        window.location.href = '/login.html';
        return null;
      }

      try {
        const response = await fetch(API_BASE + endpoint, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.status === 401) {
          alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          window.location.href = '/login.html';
          return null;
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('API Error:', error);
        return null;
      }
    }

    // Load Overview Stats
    async function loadOverview() {
      const result = await apiCall('/overview');
      if (!result || !result.success) {
        document.getElementById('overview-stats').innerHTML = '<div class="error">í†µê³„ ë¡œë“œ ì‹¤íŒ¨</div>';
        return;
      }

      const data = result.data;
      const html = `
        <div class="stat-card">
          <h3>ì „ì²´ ê¸°ê´€</h3>
          <div class="value">${data.organizations.total}</div>
          <div class="subtitle">í™œì„±: ${data.organizations.active} / ì „ì²´: ${data.organizations.alive}</div>
        </div>
        <div class="stat-card">
          <h3>ì „ì²´ ì‚¬ìš©ì</h3>
          <div class="value">${data.users.total}</div>
          <div class="subtitle">ìŠ¹ì¸: ${data.users.approved} / ëŒ€ê¸°: ${data.users.pending}</div>
        </div>
        <div class="stat-card">
          <h3>ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰</h3>
          <div class="value">${data.usage.total_used_hours.toFixed(1)}h</div>
          <div class="subtitle">í• ë‹¹: ${data.usage.total_quota_hours}h (${data.usage.usage_percentage}%)</div>
          <div class="progress-bar">
            <div class="progress-fill ${data.usage.usage_percentage > 80 ? 'warning' : ''}" 
                 style="width: ${Math.min(data.usage.usage_percentage, 100)}%"></div>
          </div>
        </div>
        <div class="stat-card">
          <h3>ì´ í¬ë ˆë”§</h3>
          <div class="value">${(data.credits.total_balance || 0).toLocaleString()}ì›</div>
          <div class="subtitle">ì‚¬ìš©: ${(data.credits.total_used || 0).toLocaleString()}ì›</div>
        </div>
        <div class="stat-card">
          <h3>ì´ë²ˆ ë‹¬ ê²°ì œ</h3>
          <div class="value">${(data.payments.total_revenue || 0).toLocaleString()}ì›</div>
          <div class="subtitle">${data.payments.successful_payments}ê±´ ì„±ê³µ</div>
        </div>
        <div class="stat-card">
          <h3>ìµœê·¼ 7ì¼ í™œë™</h3>
          <div class="value">${data.recent_activity.active_users_7d}</div>
          <div class="subtitle">${data.recent_activity.total_logs_7d}ê±´ ìµëª…í™”</div>
        </div>
      `;
      document.getElementById('overview-stats').innerHTML = html;
    }

    // Load Organizations
    async function loadOrganizations() {
      const content = document.getElementById('organizations-content');
      content.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>';

      const result = await apiCall('/organizations/usage?limit=50');
      if (!result || !result.success) {
        content.innerHTML = '<div class="error">ê¸°ê´€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        return;
      }

      const orgs = result.data.organizations;
      if (orgs.length === 0) {
        content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‚</div><p>ë“±ë¡ëœ ê¸°ê´€ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      const html = `
        <table>
          <thead>
            <tr>
              <th>ê¸°ê´€ëª…</th>
              <th>í”Œëœ</th>
              <th>ì‚¬ìš©ì</th>
              <th>ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰</th>
              <th>ì‚¬ìš©ë¥ </th>
              <th>ìƒíƒœ</th>
            </tr>
          </thead>
          <tbody>
            ${orgs.map(org => `
              <tr>
                <td><strong>${org.name}</strong><br><small>${org.region || '-'}</small></td>
                <td><span class="badge info">${org.plan_type}</span></td>
                <td>${org.approved_user_count} / ${org.user_count}</td>
                <td>${org.used_hours.toFixed(1)}h / ${org.quota_hours}h</td>
                <td>
                  ${org.usage_percentage}%
                  <div class="progress-bar">
                    <div class="progress-fill ${org.is_quota_exceeded ? 'danger' : org.is_high_usage ? 'warning' : ''}" 
                         style="width: ${Math.min(org.usage_percentage, 100)}%"></div>
                  </div>
                </td>
                <td>
                  ${org.subscription_status === 'active' 
                    ? '<span class="badge success">í™œì„±</span>' 
                    : '<span class="badge warning">ë¹„í™œì„±</span>'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      content.innerHTML = html;
    }

    // Load Users
    async function loadUsers() {
      const content = document.getElementById('users-content');
      content.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>';

      const result = await apiCall('/users/usage?limit=50');
      if (!result || !result.success) {
        content.innerHTML = '<div class="error">ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        return;
      }

      const users = result.data.users;
      if (users.length === 0) {
        content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div><p>ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      const html = `
        <table>
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ê¸°ê´€</th>
              <th>ì—­í• </th>
              <th>í¬ë ˆë”§ ì”ì•¡</th>
              <th>ì´ ì‚¬ìš©ì•¡</th>
              <th>ìµëª…í™” íšŸìˆ˜</th>
              <th>ìƒíƒœ</th>
            </tr>
          </thead>
          <tbody>
            ${users.map(user => `
              <tr>
                <td>
                  <strong>${user.name || user.oauth_nickname}</strong><br>
                  <small>${user.email || user.oauth_provider}</small>
                </td>
                <td>${user.organization_name || '-'}</td>
                <td>
                  ${user.role === 'system_admin' 
                    ? '<span class="badge danger">System Admin</span>' 
                    : user.role === 'org_admin' 
                    ? '<span class="badge warning">Org Admin</span>' 
                    : '<span class="badge info">User</span>'}
                </td>
                <td>${(user.balance || 0).toLocaleString()}ì›</td>
                <td>${(user.total_used || 0).toLocaleString()}ì›</td>
                <td>${user.total_anonymizations || 0}íšŒ</td>
                <td>
                  ${user.is_approved 
                    ? '<span class="badge success">ìŠ¹ì¸</span>' 
                    : '<span class="badge warning">ëŒ€ê¸°</span>'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      content.innerHTML = html;
    }

    // Load Activity
    async function loadActivity() {
      const content = document.getElementById('activity-content');
      content.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>';

      const result = await apiCall('/activity-logs?days=7&limit=50');
      if (!result || !result.success) {
        content.innerHTML = '<div class="error">í™œë™ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨</div>';
        return;
      }

      const data = result.data;
      const html = `
        <h3>ìµœê·¼ ìµëª…í™” í™œë™ (${data.recent_anonymizations.length}ê±´)</h3>
        <table style="margin-bottom: 30px;">
          <thead>
            <tr>
              <th>ì‚¬ìš©ì</th>
              <th>ê¸°ê´€</th>
              <th>íŒŒì¼ëª…</th>
              <th>ì²˜ë¦¬ì‹œê°„</th>
              <th>ìµëª…í™” ê°œìˆ˜</th>
              <th>ì‹œê°„</th>
            </tr>
          </thead>
          <tbody>
            ${data.recent_anonymizations.slice(0, 20).map(log => `
              <tr>
                <td>${log.user_name || '-'}</td>
                <td>${log.organization_name || '-'}</td>
                <td>${log.file_name}</td>
                <td>${(log.processing_time_minutes || 0).toFixed(2)}ë¶„</td>
                <td>${log.total_anonymized || 0}ê°œ</td>
                <td>${new Date(log.created_at).toLocaleString('ko-KR')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <h3>ìµœê·¼ ê²°ì œ (${data.recent_payments.length}ê±´)</h3>
        <table>
          <thead>
            <tr>
              <th>ì‚¬ìš©ì</th>
              <th>ê¸ˆì•¡</th>
              <th>ê²°ì œ ìˆ˜ë‹¨</th>
              <th>ìƒíƒœ</th>
              <th>ì‹œê°„</th>
            </tr>
          </thead>
          <tbody>
            ${data.recent_payments.slice(0, 20).map(payment => `
              <tr>
                <td>${payment.user_name || '-'}</td>
                <td>${payment.amount.toLocaleString()}ì›</td>
                <td>${payment.payment_method || '-'}</td>
                <td>
                  ${payment.status === 'success' 
                    ? '<span class="badge success">ì„±ê³µ</span>' 
                    : payment.status === 'failed' 
                    ? '<span class="badge danger">ì‹¤íŒ¨</span>' 
                    : '<span class="badge warning">ëŒ€ê¸°</span>'}
                </td>
                <td>${new Date(payment.created_at).toLocaleString('ko-KR')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      content.innerHTML = html;
    }

    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Add active class to clicked tab
        tab.classList.add('active');
        const tabName = tab.dataset.tab;
        document.getElementById(tabName).classList.add('active');

        // Load data for active tab
        if (tabName === 'organizations') {
          loadOrganizations();
        } else if (tabName === 'users') {
          loadUsers();
        } else if (tabName === 'activity') {
          loadActivity();
        }
      });
    });

    // Initial Load
    window.addEventListener('DOMContentLoaded', () => {
      loadOverview();
      loadOrganizations();
    });

    // Auto refresh every 5 minutes
    setInterval(() => {
      loadOverview();
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      if (activeTab === 'organizations') {
        loadOrganizations();
      } else if (activeTab === 'users') {
        loadUsers();
      } else if (activeTab === 'activity') {
        loadActivity();
      }
    }, 300000); // 5 minutes
  </script>
</body>
</html>
